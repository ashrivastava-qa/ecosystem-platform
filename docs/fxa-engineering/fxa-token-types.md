---
id: fxa-token-types
title: Types of Auth Token in FxA
sidebar_label: Types of Auth Token
---

Last updated: `December 04th, 2019`

Firefox Accounts uses a number of different types of "token" to keep track of whether a user has been authenticated,
and of what actions a client is authorized to perform. This document provides an overview of the different types of
token, their properties and intended uses.

The most important types of token for FxA Replying Parties to know about are:

* [Session Tokens](#session-tokens), long-lived tokens that represent an authenticated user session with the FxA servers.
* [OAuth Refresh Tokens](#oauth-refresh-tokens), long-lived tokens indicating that the user has authorized a particular client to perform
  particular actions on their behalf.
* [OAuth Access Tokens](#oauth-access-tokens), short-lived tokens used by authorized clients when performing particular actions
  on behalf of the user.
* [OIDC Identity Tokens](#oidc-identity-tokens), short-lived JWTs used to communicate an authentication event from FxA
  to a relying party.

FxA has additional types of token that it uses for its own account-management purposes, but which should
never be visible to Relying Parties:

* [KeyFetch Tokens](#keyfetch-tokens)
* [Password Change Tokens](#password-change-tokens)
* [Password Forgot Tokens](#password-forgot-tokens)
* [Account Reset Tokens](#account-reset-tokens)

Relying Parties that wish to integrate with Firefox Sync may also need to know about these additional types
of token:

* [BrowserID Assertions](#browserid-assertions)
* [Sync Storage Credentials](#sync-storage-credentials)

# Token Usage Mechanisms

A ***Bearer Token*** is an opaque string that can be used by any client in posession of the token, simply by presenting
it verbatim in the request to the server (e.g. in the `Authorization` header). These are the simplest types of token
for clients to use, but allow for interception and reply attacks. In particular, the server the receives a Bearer Token
is capable of extracting it and using it to perform other API calls.

A ***Hawk Token*** consists of an opaque string id and corresponding secret key. To use the token, clients must use the
secret key to sign outgoing requests using [the scheme described here](https://hapi.dev/family/hawk/). This is more
complicated for clients but it binds the use of the token to the particular request being made, and it offers the
potential for replay prevention.

An ***FxA Hawk Token*** is a 32-byte string from which the id and key of a ***Hawk Token*** can be generated using HKDF.
This simplifies client handling of the token since it only has to persist a single value.

# Session Tokens

A `sessionToken` is the Firefox Accounts equivalent of traditional website login session cookie - it represents
the user who is currently signed in to accounts.firefox.com, and it used to authenticate many calls from the
FxA front-end website to the FxA back-end API.

Session tokens are an ***FxA Hawk Token*** where the 32-byte string is generated by the server. They can be obtained by:
* The successful creation of a new account, via the `/account/create` endpoint.
* A successful login to a new account, via the `/account/login` endpoint.
* Duplicating an existing `sessionToken`, via the `/session/duplicate` endpoint.
* Providing the id of a previous `sessionToken` when changing the account password, via the `/password/change/finish`
  endpoint.
* Requesting the `https://identity.mozilla.com/tokens/session` scope during an OAuth flow.

Session tokens are intended only for authenticating communication with the FxA servers themselves, so RP servers
should never encounter a session token in the wild.

On the client side, session tokens are typically handled by web content on accounts.firefox.com while the user
is interacting with their account. However, web browsers that support signing in with FxA in order to access
account-enabled browser features, may obtain a session token during the sigin flow and use it to communicate
directly with the FxA server APIs.

TODO: we should better articulate ownership expections here, around webchannels etc.

# Session Metadata

Since session tokens represent a signed-in user, the server maintains a lot of additional metadata about the user's
signed-in state. Properties of the session token include:

* The types of authentication performed by the user, and level of confidence in their identity.
* Timestamp at which authentication last occurred (which can be increased by prompting the user to re-enter their
  password).
* Timestamp at which the token was last used (truncated to a few hours granularity to reduce db write load).
* Details of the user-agent string from the last use of the token.

This information may be used by the FxA server to make authorization decisions, and RPs may request that a user
be authenticated to a certain level of assurance (such as requiring that the sessionToken be last-authenticated
within a certain amount of time, or authenticated via 2FA).

## Verified Sessions

As an additional security measure against [credential-stuffing
attacks](https://blog.mozilla.org/services/2016/04/09/stolen-passwords-used-to-break-into-firefox-accounts/),
FxA has the notion of a "verified session", which is intended to indicate a higher level of confidence in the
authenticity of the user.

A session is considered verified if the user did some additional authentication step *in addition* to proving
knowledge of the account password, such as completing an email confirmation loop or answering a 2FA challenge.
Sessions may also be considered verified based on server-side heuristics, such as whether the account is newly-created
or whether we've seen previous verified logins form the same IP address.

Certain actions on the account can only be performed with a verified session, including:
* Modifying email or 2FA settings
* Authorizing OAuth grants that involve key-bearing scopes

## Multi-Factor Auth

If the user enalbes two-step authentication on their account, then each sessionToken will keep track of
whether it has been involved in a successful 2FA authentication. This information is reported in the session
metadata in two ways:

* The "authenticator assurance level" or "AAL" is a numeric indicator of the number of distinct types of
  authentication factor that have been provided for a session; it will be `2` for sessions in which the user
  has successfully successfully performed 2FA.
* The "authentication methods" is a list of all the different types of authentication action that have been
  performed on this session (such as "entered password" or "completed email loop" or "provided totp code").
  It's a more detailed view than the summary provided by the AAL.

# OAuth Refresh Tokens

RPs that wish to obtain long-lived permission to access the user's account data should request
an [OAuth Refresh Token](https://oauth.net/2/grant-types/refresh-token/) as part of their authorization flow.
This is a long-lived ***Bearer Token*** that represents the permissions granted by the user to that RP.
For example the refresh token might indicate that the RP has permission to read the user's profile data.

Refresh tokens can only be created by authorizing them via a valid `sessionToken`.

Refresh tokens should only ever be presented to the FxA auth/oauth server, and should **not** be used when
talking to other resource servers. Instead, the RP should use the refresh token to generate a short-lived
[access token][#oauth-access-tokens] and use that to communicate with resource servers.

TODO: talk more about scopes here?
TODO: hypothesize about how we could make these more secure in future?

# OAuth Access Tokens

RPs that wish to access resource servers on behalf of the user (say, to read or store user data) need
to obtain an [OAuth Access Token](https://www.oauth.com/oauth2-servers/access-tokens/).  This is a short-lived
***Bearer Token*** that represents the permissions granted by the user to that RP, in a format that can
be consumed by resource servers. For example the RP might use an access token with scope "profile" in order
to read the user's profile data from the FxA profile server.

TODO: talk more about scopes here?
TODO: hypothesize about how we could make these more secure in future?

# OIDC Identity Tokens

They're for signin. Link to OIDC spec, and explain why they're useful.

# KeyFetch Tokens

They're for fetching keys. RPs shouldn't need to now this, because they use the scoped-keys flow.
Talk a bit about verification and how it relates to sessionToken verification.
Explain the whole scrypt-on-the-server thing, and the way we encrypt the keys for communicating
back to the client.

# Password Change Tokens

Special-use token for changing password. Hawk token.

# Password Forgot Tokens

Special-use token for resetting password. Needs to be verified via a code received over email.
Limited number of verification attempts. Generates a reset token.

# Account Reset Tokens

Special-use token for resetting the password. I need to remember why this is a separate token...

# BrowserID Assertions

Legacy identity assertion format. Used by sync, and accepted when granting OAuth tokens, but
should not be used for anything new. Maybe link to an ADR describing our plan to get rid of them.

# Sync Storage Credentials

Not sure if this belongs here, since it's not really FxA. But it's a thing sync clients need to
know about. Exchange BID assertion of OAuth token for special sync credentails.
It might be a good place to explain how we'd like this to go away in the future, in favour
of just using oauth token directly.